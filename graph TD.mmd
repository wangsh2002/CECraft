graph TD
    %% --- æ ·å¼å®šä¹‰ (è®©å›¾æ›´å¥½çœ‹) ---
    classDef agent fill:#ffebcc,stroke:#ff9900,stroke-width:2px,color:#333;
    classDef tool fill:#e1f5fe,stroke:#0288d1,stroke-width:1px,color:#333;
    classDef storage fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5,color:#333;
    classDef finish fill:#333,stroke:#333,stroke-width:2px,color:#fff;

    %% --- ä¸»æµç¨‹ ---
    User[ğŸ’» ç”¨æˆ·å‰ç«¯] -->|POST /api/ai/agent| Supervisor
    
    subgraph Brain [ğŸ§  æ€»æ§å¤§è„‘]
        Supervisor{æ„å›¾è·¯ç”±}:::agent
    end

    %% åˆ†æ”¯è·¯ç”±
    Supervisor -- "é—²èŠ" --> ChatBot[ğŸ’¬ Chat Agent]:::agent
    Supervisor -- "ç›´æ¥ä¿®æ”¹" --> Drafter
    Supervisor -- "éœ€è¦å¤–éƒ¨ä¿¡æ¯/JDå¯¹æ ‡" --> Researcher[ğŸ•µï¸ Researcher Agent]:::agent

    %% --- èµ„æ–™æ£€ç´¢æ¨¡å— ---
    subgraph Research_Tools [ğŸ” æ™ºèƒ½æ£€ç´¢å·¥å…·é“¾]
        direction TB
        Researcher --> ToolRouter{æ£€ç´¢æºåˆ¤æ–­}
        
        %% è·¯å¾„ A: å¤–éƒ¨å·¥å…·
        ToolRouter -- "æœJD/å…¬å¸" --> SearXNG[ğŸŒ è”ç½‘æœç´¢]:::tool
        SearXNG --> Crawl4AI[ğŸ•·ï¸ çˆ¬è™«è§£æ]:::tool
        Crawl4AI --> Summary[ğŸ“ å…³é”®ä¿¡æ¯æ‘˜è¦]:::tool
        
        %% è·¯å¾„ B: å†…éƒ¨çŸ¥è¯†åº“
        ToolRouter -- "æœè¯æœ¯/èŒƒä¾‹" --> VectorDB[(ğŸ›¢ï¸ å‘é‡æ•°æ®åº“)]:::storage
        VectorDB --> ReRank[âš–ï¸ è¯­ä¹‰é‡æ’åº]:::tool
        
        %% æ•°æ®èåˆ
        Summary --> Merger[âš—ï¸ ä¸Šä¸‹æ–‡èåˆ]:::tool
        ReRank --> Merger
    end
    
    %% å…³é”®è·¯å¾„ä¼˜åŒ–ï¼šResearcher è·å–æ•°æ®åï¼Œç›´æ¥ä¼ ç»™ Drafter
    Merger -->|åŒ…å«: JDé‡ç‚¹+ä¼˜ç§€èŒƒä¾‹| Drafter

    %% --- ç”Ÿäº§ä¸è´¨æ£€æ¨¡å— ---
    subgraph Iteration_Loop [âš¡ å†™ä½œä¸è´¨æ£€é—­ç¯]
        direction TB
        Drafter[âœï¸ Drafter Agent]:::agent
        Reviewer[ğŸ§ Reviewer Agent]:::agent
        
        Drafter -->|æäº¤è‰ç¨¿| ReviewLogic{è¯„å®¡å†³ç­–}
        
        ReviewLogic -- "âŒ ä¸åˆæ ¼ (é™„ä¿®æ”¹æ„è§)" --> Drafter
        ReviewLogic -- "âœ… é€šè¿‡" --> Formatter[âš™ï¸ æ ¼å¼åŒ– JSON]:::tool
    end

    %% --- ç»Ÿä¸€è¾“å‡º ---
    ChatBot --> FinalResponse
    Formatter --> FinalResponse
    
    FinalResponse[ğŸš€ API æ ‡å‡†å“åº”]:::finish